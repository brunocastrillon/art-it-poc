@{
    ViewData["Title"] = "Clientes";
}

<h2>Clientes</h2>

<button class="btn btn-success mb-3" id="btnNovo">Novo Cliente</button>

<table class="table table-bordered" id="clientesTable">
    <thead>
        <tr>
            <th>Código</th>
            <th>Razão Social</th>
            <th>Nome Fantasia</th>
            <th>Documento</th>
            <th>Ações</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<h4 class="mt-4">Telefones do Cliente</h4>
<table class="table table-bordered" id="tabelaTelefones">
    <thead>
        <tr>
            <th>Número</th>
            <th>Tipo</th>
            <th>Operadora</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- Modal -->
<div class="modal fade" id="clienteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="clienteForm" novalidate>
                <div class="modal-header">
                    <h5 class="modal-title">Cadastro de Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="codigoCliente" />

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Razão Social</label>
                            <input type="text" class="form-control" id="razaoSocial" required>
                            <div class="invalid-feedback">Informe a Razão Social.</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Nome Fantasia</label>
                            <input type="text" class="form-control" id="nomeFantasia" required>
                            <div class="invalid-feedback">Informe o Nome Fantasia.</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tipo Pessoa</label>
                            <input type="text" class="form-control" id="tipoPessoa">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Documento</label>
                            <input type="text" class="form-control" id="documento" required>
                            <div class="invalid-feedback">Informe o Documento.</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Endereço</label>
                            <input type="text" class="form-control" id="endereco">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Complemento</label>
                            <input type="text" class="form-control" id="complemento">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Bairro</label>
                            <input type="text" class="form-control" id="bairro">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Cidade</label>
                            <input type="text" class="form-control" id="cidade">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">CEP</label>
                            <input type="text" class="form-control" id="cep">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">UF</label>
                            <input type="text" class="form-control" id="uf">
                        </div>
                    </div>

                    <hr />
                    <h5>Telefones</h5>
                    <div class="row g-2 mb-2">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="numeroTelefone" placeholder="Número">
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="operadora" placeholder="Operadora">
                        </div>
                        <div class="col-md-4">
                            <select id="tipoTelefoneSelect" class="form-select">
                                <option value="">Tipo de Telefone</option>
                            </select>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary mb-2" id="btnAddTelefone">Adicionar Telefone</button>

                    <table class="table table-sm table-bordered" id="tabelaTelefonesTemp">
                        <thead>
                            <tr>
                                <th>Número</th>
                                <th>Tipo</th>
                                <th>Operadora</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const apiUrl = "https://localhost:7294/api/cliente";
        let modal;
        let telefonesTemp = [];

        $(document).ready(function () {
            modal = new bootstrap.Modal(document.getElementById('clienteModal'));
            carregarClientes();

            $("#btnNovo").click(() => {
                limparFormulario();
                carregarTiposTelefone();
                modal.show();
            });

            $("#clienteForm").submit(function (e) {
                e.preventDefault();

                const form = this;

                if (!form.checkValidity()) {
                    form.classList.add('was-validated');
                    return;
                }

                telefonesTemp.forEach(t => {
                    console.log(t);
                    console.log(t.tipoTelefoneDesc);
                    console.log(obterCodigoTipoTelefonePorDescricao(t.tipoTelefoneDesc));
                    console.log(t.codigoTipoTelefone);
                });

                // Normaliza os telefones da lista temporária
                const telefonesFormatados = telefonesTemp.map(t => ({
                    numeroTelefone: t.numeroTelefone,
                    operadora: t.operadora,
                    codigoTipoTelefone: t.tipoTelefoneDesc ? obterCodigoTipoTelefonePorDescricao(t.tipoTelefoneDesc)
                                                           : t.codigoTipoTelefone ?? t.tipoTelefone?.codigoTipoTelefone ?? null,
                    ativo: t.ativo ?? true,
                    dataInsercao: t.dataInsercao ?? new Date().toISOString(),
                    usuarioInsercao: t.usuarioInsercao ?? "WebApp"
                }));

                const cliente = {
                    codigoCliente: $("#codigoCliente").val() || 0,
                    razaoSocial: $("#razaoSocial").val(),
                    nomeFantasia: $("#nomeFantasia").val(),
                    tipoPessoa: $("#tipoPessoa").val(),
                    documento: $("#documento").val(),
                    endereco: $("#endereco").val(),
                    complemento: $("#complemento").val(),
                    bairro: $("#bairro").val(),
                    cidade: $("#cidade").val(),
                    cep: $("#cep").val(),
                    uf: $("#uf").val(),
                    telefones: telefonesFormatados
                };

                const isEdicao = cliente.codigoCliente > 0;
                const verbo = isEdicao ? "PUT" : "POST";
                const url = isEdicao ? `https://localhost:7294/api/Cliente/${cliente.codigoCliente}` : `https://localhost:7294/api/Cliente`;

                $.ajax({
                    type: verbo,
                    url: url,
                    contentType: "application/json",
                    data: JSON.stringify(cliente),
                    success: function () {
                        $("#clienteModal").modal("hide");
                        carregarClientes(); // Atualiza a lista
                        exibirMensagem("Cliente salvo com sucesso!");
                    },
                    error: function (xhr) {
                        const erro = xhr.responseJSON?.title || "Erro ao salvar cliente.";
                        exibirMensagem(erro, true);
                    }
                });
            });

            $("#btnAddTelefone").click(() => {
                const numero = $("#numeroTelefone").val().replace(/\D/g, "");
                const operadora = $("#operadora").val();
                const tipoId = $("#tipoTelefoneSelect").val();
                const tipoTexto = $("#tipoTelefoneSelect option:selected").text();

                if (!numero || !operadora || !tipoId) {
                    alert("Preencha todos os campos do telefone.");
                    return;
                }

                if (telefonesTemp.some(t => t.numeroTelefone === numero)) {
                    alert("Telefone já adicionado.");
                    return;
                }

                telefonesTemp.push({
                    numeroTelefone: numero,
                    operadora: operadora,
                    codigoTipoTelefone: parseInt(tipoId),
                    ativo: true,
                    dataInsercao: new Date().toISOString(),
                    usuarioInsercao: "WebApp"
                });

                atualizarTabelaTelefonesTemp();
                limparCamposTelefone();
            });

            $(document).on("click", ".btn-editar", function () {
                const id = $(this).data("id");
                $.get(`${apiUrl}/${id}`, function (c) {
                    $("#codigoCliente").val(c.codigoCliente);
                    $("#razaoSocial").val(c.razaoSocial);
                    $("#nomeFantasia").val(c.nomeFantasia);
                    $("#tipoPessoa").val(c.tipoPessoa);
                    $("#documento").val(c.documento);
                    $("#endereco").val(c.endereco);
                    $("#complemento").val(c.complemento);
                    $("#bairro").val(c.bairro);
                    $("#cidade").val(c.cidade);
                    $("#cep").val(c.cep);
                    $("#uf").val(c.uf);
                    telefonesTemp = c.telefones || [];
                    atualizarTabelaTelefonesTemp();
                    carregarTiposTelefone();
                    modal.show();
                });
            });

            $(document).on("click", ".btn-excluir", function () {
                const id = $(this).data("id");
                if (confirm("Deseja realmente excluir este cliente?")) {
                    $.ajax({
                        url: `${apiUrl}/${id}`,
                        type: "DELETE",
                        success: carregarClientes
                    });
                }
            });

            $(document).on("click", ".btn-vertelefones", function () {
                const id = $(this).data("id");
                $.get(`${apiUrl}/${id}`, function (cliente) {
                    const tbody = $("#tabelaTelefones tbody").empty();
                    (cliente.telefones || []).forEach(t => {
                        tbody.append(`<tr><td>${t.numeroTelefone}</td><td>${t.tipoTelefoneDesc || ''}</td><td>${t.operadora}</td></tr>`);
                    });
                });
            });
        });

        function carregarClientes() {
            $.get(apiUrl, function (data) {
                const tbody = $("#clientesTable tbody").empty();
                data.forEach(c => {
                    tbody.append(`<tr>
                        <td>${c.codigoCliente}</td>
                        <td>${c.razaoSocial}</td>
                        <td>${c.nomeFantasia}</td>
                        <td>${c.documento}</td>
                        <td>
                            <button class="btn btn-primary btn-sm btn-editar" data-id="${c.codigoCliente}">Editar</button>
                            <button class="btn btn-danger btn-sm btn-excluir" data-id="${c.codigoCliente}">Excluir</button>
                            <button class="btn btn-info btn-sm btn-vertelefones" data-id="${c.codigoCliente}">Telefones</button>
                        </td>
                    </tr>`);
                });
            });
        }

        function atualizarTabelaTelefonesTemp() {
            const tbody = $("#tabelaTelefonesTemp tbody").empty();

            telefonesTemp.forEach(t => {

                console.log(t);

                const idTipoTelefone = obterCodigoTipoTelefonePorDescricao(t.tipoTelefoneDesc);
                const descricaoTipo = t.tipoTelefone?.descricaoTipoTelefone || obterDescricaoTipoTelefone(t.codigoTipoTelefone) || "N/A";

                console.log(idTipoTelefone);
                console.log(descricaoTipo);

                tbody.append(`
                    <tr>
                        <td>${t.numeroTelefone}</td>
                        <td>${t.tipoTelefoneDesc}</td>
                        <td>${t.operadora}</td>
                        <td><button class="btn btn-danger btn-sm btn-remover-telefone" data-numero="${t.numeroTelefone}" data-cliente="${t.codigoCliente}">Remover</button></td>
                    </tr>
                `);
            });
        }


        $(document).on("click", ".btn-remover-telefone", function () {
            const numero = $(this).data("numero");
            const cliente = $(this).data("cliente");

            if (!cliente || cliente == 0) {
                telefonesTemp = telefonesTemp.filter(t => t.numeroTelefone !== numero);
                atualizarTabelaTelefonesTemp();
            } else {
                if (!confirm("Deseja remover este telefone do banco de dados?")) return;

                $.ajax({
                    url: `https://localhost:7294/api/Telefones/${cliente}/${numero}`,
                    type: "DELETE",
                    success: function () {
                        alert("Telefone removido com sucesso!");
                        carregarClientes();
                    },
                    error: function (err) {
                        console.error("Erro ao remover telefone:", err);
                        alert("Erro ao remover telefone.");
                    }
                });
            }
        });

        function carregarTiposTelefone() {
            $.get("https://localhost:7294/api/TipoTelefone", function (data) {
                const select = $("#tipoTelefoneSelect").empty().append(`<option value="">Tipo de Telefone</option>`);
                data.forEach(t => {
                    select.append(`<option value="${t.codigoTipoTelefone}">${t.descricaoTipoTelefone}</option>`);
                });
            });
        }

        function limparFormulario() {
            document.getElementById("clienteForm").reset();
            document.getElementById("clienteForm").classList.remove('was-validated');
            telefonesTemp = [];
            atualizarTabelaTelefonesTemp();
        }

        function obterDescricaoTipoTelefone(codigo) {
            return $(`#tipoTelefone option[value='${codigo}']`).text();
        }

        function limparCamposTelefone() {
            $("#numeroTelefone").val("");
            $("#operadora").val("");
            $("#tipoTelefone").val("");
        }

        function obterCodigoTipoTelefonePorDescricao(descricao) {
            const option = $("#tipoTelefone option").filter(function () {
                return $(this).text().trim() === descricao.trim();
            }).first();
            return option.length ? parseInt(option.val()) : null;
        }

    </script>
}
